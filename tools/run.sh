#!/usr/bin/env bash

REPORTS="output/reports"
CSV_FILE="output/execution_times.csv"

# Function to record execution time
record_execution_time() {
    local tool="$1"
    start=$(date +%s.%3N)
    
    # Run the jar
    eval "$2"
    
    local duration=$(echo "$(date +%s.%3N) - $start" | bc)

     # Append execution time to CSV file (a little adjustment for roseau's bcs report to be in roseau's directory)

    echo "$tool, $duration" >> "$CSV_FILE"
}

[ -d "$REPORTS" ] || mkdir "$REPORTS"

# Create or clear the CSV file                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
echo "Task, Execution Time (s)" > "$CSV_FILE"

echo "********* Revapi *********"
record_execution_time "Revapi" "tools/revapi/revapi.sh --extensions=org.revapi:revapi-java:0.28.1,org.revapi:revapi-reporter-text:0.15.0 --old=build/lib-v1.jar --new=build/lib-v2.jar -Drevapi.reporter.text.minSeverity=POTENTIALLY_BREAKING > $REPORTS/revapi.txt"

echo "********* japicmp *********"
record_execution_time "japicmp" "java -jar tools/japicmp/japicmp-0.23.0-jar-with-dependencies.jar -o build/lib-v1.jar -n build/lib-v2.jar -b -m > $REPORTS/japicmp.txt"

echo "********* Roseau *********"
record_execution_time "Roseau" "java -jar tools/roseau/roseau-0.0.4-SNAPSHOT-jar-with-dependencies.jar --diff --v1 lib-v1 --v2 lib-v2 --report=output/reports/roseau.csv  > $REPORTS/roseau.txt"


grep  -v '===  UNCHANGED' "$REPORTS"/japicmp.txt > japicmp.txt.tmp
mv japicmp.txt.tmp "$REPORTS"/japicmp.txt

grep  -v '===  UNCHANGED' "$REPORTS"/roseau.txt > roseau.txt.tmp
mv roseau.txt.tmp "$REPORTS"/roseau.txt
